apiVersion: batch/v1
kind: Job
metadata:
  generateName: presync-security-checks-
  namespace: default
  annotations:
    # Hook de ArgoCD: se ejecuta antes de la sincronizaci√≥n
    argocd.argoproj.io/hook: PreSync
    # Elimina el Job despu√©s de completarse exitosamente
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  # Reintentos permitidos
  backoffLimit: 2
  template:
    metadata:
      name: presync-security-checks
    spec:
      restartPolicy: Never
      containers:
      - name: security-checks
        image: node:24-alpine
        workingDir: /app
        command:
        - sh
        - -c
        - |
          echo "====================================="
          echo "INICIANDO VERIFICACIONES DE SEGURIDAD"
          echo "====================================="
          
          # Clonar el repositorio
          echo "üì¶ Clonando repositorio..."
          apk add --no-cache git
          git clone https://github.com/1756096090/frontendMedicalRecord2.git /app
          cd /app
          
          # Instalar dependencias
          echo "üì• Instalando dependencias..."
          npm ci || npm install
          
          echo ""
          echo "====================================="
          echo "üîç ESLINT - AN√ÅLISIS DE C√ìDIGO"
          echo "====================================="
          npm run lint || {
            echo "‚ö†Ô∏è  ESLint encontr√≥ problemas. Revisar el c√≥digo."
            exit 1
          }
          echo "‚úÖ ESLint: Sin problemas detectados"
          
          echo ""
          echo "====================================="
          echo "üõ°Ô∏è  OWASP - AN√ÅLISIS DE VULNERABILIDADES"
          echo "====================================="
          set +e  # No detener el script por errores
          npm audit --audit-level=moderate
          AUDIT_EXIT_CODE=$?
          if [ $AUDIT_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è  Se encontraron vulnerabilidades de seguridad."
            echo "üìä Generando reporte..."
            npm audit --json > /tmp/npm-audit.json || true
            echo "‚ö†Ô∏è  Advertencia: Se encontraron vulnerabilidades, pero el deployment continuar√°."
          fi
          set -e  # Reactivar detenci√≥n por errores
          echo "‚úÖ OWASP: An√°lisis completado"
          
          echo ""
          echo "====================================="
          echo "‚úÖ VERIFICACIONES COMPLETADAS"
          echo "====================================="
          echo "El c√≥digo est√° listo para deployment"

version: 2.1

parameters:
  notify_telegram:
    type: boolean
    default: true

executors:
  node24_browsers:
    docker:
      - image: cimg/node:24.6-browsers

jobs:
  build_test_package:
    executor: node24_browsers
    environment:
      CI: "true"
      APP_URL: "http://localhost:4173"
    steps:
      - checkout

      - run:
          name: Versions
          command: |
            node -v
            npm -v
            npx vite --version || true

      # Cache npm por lockfile
      - run:
          name: Cache key
          command: |
            if [ -f package-lock.json ]; then
              echo "export NPM_LOCK_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)" >> $BASH_ENV
            else
              echo "export NPM_LOCK_HASH=no-lock" >> $BASH_ENV
            fi
            source $BASH_ENV
      - restore_cache:
          keys:
            - npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
            - npm-v1-{{ arch }}-

      - run:
          name: Install deps
          command: |
            if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - save_cache:
          key: npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
          paths:
            - ~/.npm

      - run:
          name: Build (si existe) y validar dist
          command: |
            # Build condicional
            node -e "try{const p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              npm run build
            else
              echo 'No hay script "build"; se omite.'
            fi

            # Validación fuerte de dist
            if [ ! -d dist ]; then
              echo "❌ No existe ./dist. Revisa el log de build."
              exit 1
            fi
            if [ ! -f dist/index.html ]; then
              echo "❌ No existe ./dist/index.html. Vite preview necesita ese archivo."
              ls -la dist || true
              exit 1
            fi

      - run:
          name: Start preview server (background) y esperar disponibilidad
          command: |
            # Elige comando: npm run serve:ci (si existe) o fallback a npx vite preview
            SERVE_CMD=""
            node -e "try{const p=require('./package.json');process.exit(p.scripts && p.scripts['serve:ci']?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              SERVE_CMD="npm run serve:ci"
            else
              SERVE_CMD="npx vite preview --host 0.0.0.0 --port 4173 --strictPort"
            fi
            echo "Usando: $SERVE_CMD"

            ($SERVE_CMD &> /tmp/preview.log) &
            PREVIEW_PID=$!

            # Espera hasta 120s a que responda
            for i in $(seq 1 120); do
              if curl -fsS "${APP_URL}" >/dev/null; then
                echo "✅ preview listo en ${APP_URL} (pid=$PREVIEW_PID)"
                break
              fi
              # Si el proceso murió, aborta y muestra log
              if ! ps -p $PREVIEW_PID >/dev/null 2>&1; then
                echo "❌ 'vite preview' se detuvo (falló al iniciar)."
                echo "===== LOG preview (últimas 200 líneas) ====="
                tail -n 200 /tmp/preview.log || true
                exit 1
              fi
              echo "⏳ esperando preview... ($i)"
              sleep 1
            done

            # Timeout
            if ! curl -fsS "${APP_URL}" >/dev/null; then
              echo "❌ preview no respondió a tiempo (${APP_URL})"
              echo "===== LOG preview (últimas 200 líneas) ====="
              tail -n 200 /tmp/preview.log || true
              exit 1
            fi

            echo "===== LOG preview (primeras 80 líneas) ====="
            head -n 80 /tmp/preview.log || true

      - run:
          name: Selenium smoke (si existe script)
          command: |
            node -e "try{const p=require('./package.json');process.exit(p.scripts && p.scripts['test:selenium']?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              npm run test:selenium
            else
              echo "No hay script test:selenium; se omite Selenium."
            fi

      - run:
          name: Empaquetar dist.zip
          command: |
            zip -r dist.zip dist
      - store_artifacts:
          path: dist.zip
          destination: dist.zip
      - store_artifacts:
          path: /tmp/preview.log
          destination: preview.log

      - run:
          name: Notificar Telegram - SUCCESS
          when: on_success
          command: |
            if [ "<< pipeline.parameters.notify_telegram >>" = "true" ] && \
               [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
              EMOJI="✅"
              MSG="$(printf '%b' "${EMOJI} CircleCI\nEstado: SUCCESS\nRepo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nRama: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\n")"
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode=Markdown \
                   --data-urlencode text="$MSG" >/devnull || true
            fi

      - run:
          name: Notificar Telegram - FAILED
          when: on_fail
          command: |
            if [ "<< pipeline.parameters.notify_telegram >>" = "true" ] && \
               [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
              EMOJI="❌"
              MSG="$(printf '%b' "${EMOJI} CircleCI\nEstado: FAILED\nRepo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nRama: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\n")"
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode=Markdown \
                   --data-urlencode text="$MSG" >/devnull || true
            fi

workflows:
  build:
    jobs:
      - build_test_package

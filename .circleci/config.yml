version: 2.1

executors:
  node24:
    docker:
      - image: cimg/node:24.6

commands:
  restore_npm_cache:
    steps:
      - run:
          name: "Calcular llave del cache"
          command: |
            if [ -f package-lock.json ]; then
              echo "export NPM_LOCK_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)" >> $BASH_ENV
            else
              echo "export NPM_LOCK_HASH=no-lock" >> $BASH_ENV
            fi
            source $BASH_ENV
      - restore_cache:
          keys:
            - npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
            - npm-v1-{{ arch }}-

  save_npm_cache:
    steps:
      - save_cache:
          key: npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
          paths:
            - ~/.npm

jobs:
  build_and_package:
    executor: node24
    environment:
      CI: "true"
    steps:
      - checkout

      - run:
          name: Exportar REPO_NAME
          command: |
            echo "export REPO_NAME=${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" >> $BASH_ENV
            source $BASH_ENV
            echo "Repo: $REPO_NAME"
            echo "Branch: ${CIRCLE_BRANCH}"

      - restore_npm_cache

      - run:
          name: Instalar dependencias
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

      - save_npm_cache

      - run:
          name: Build (si existe script "build")
          command: |
            node -e "try{const p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              npm run build
            else
              echo 'No hay script "build"; se omite.'
            fi

      - run:
          name: Empaquetar dist.zip (si existe ./dist)
          command: |
            if [ -d dist ]; then
              zip -r dist.zip dist
            else
              echo "No existe ./dist; se omite empaquetado."
            fi
            # Evitar fallo en store_artifacts si no existe
            [ -f dist.zip ] || touch dist.zip

      - store_artifacts:
          path: dist.zip
          destination: dist.zip

      - run:
          name: Notificar por Telegram (si hay variables)
          command: |
            if [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
              STATUS="${CIRCLE_WORKFLOW_STATUS:-unknown}"
              MSG="CircleCI
Estado: ${STATUS}
Repo: ${REPO_NAME}
Rama: ${CIRCLE_BRANCH}
Build: ${CIRCLE_BUILD_URL}"
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d chat_id="${TELEGRAM_CHAT_ID}" \
                   --data-urlencode text="$MSG" >/dev/null || true
            else
              echo "TELEGRAM_BOT_TOKEN/TELEGRAM_CHAT_ID no configurados; omitiendo Telegram."
            fi

workflows:
  build:
    jobs:
      - build_and_package

version: 2.1

parameters:
  notify_telegram:
    type: boolean
    default: true

executors:
  node24_browsers:
    docker:
      - image: cimg/node:24.6-browsers   # Chrome + chromedriver incluidos

jobs:
  build_test_package:
    executor: node24_browsers
    environment:
      CI: "true"
      APP_URL: "http://localhost:4173"
    steps:
      - checkout

      - run:
          name: Echo repo/branch
          command: |
            echo "Repo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
            echo "Branch: ${CIRCLE_BRANCH}"
            echo "Commit: ${CIRCLE_SHA1}"

      # ---- Cache npm por lockfile ----
      - run:
          name: Calcular llave cache npm
          command: |
            if [ -f package-lock.json ]; then
              echo "export NPM_LOCK_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)" >> $BASH_ENV
            else
              echo "export NPM_LOCK_HASH=no-lock" >> $BASH_ENV
            fi
            source $BASH_ENV

      - restore_cache:
          keys:
            - npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
            - npm-v1-{{ arch }}-

      - run:
          name: Instalar dependencias
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

      - save_cache:
          key: npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
          paths:
            - ~/.npm

      # ---- Build condicional ----
      - run:
          name: Build (si existe script "build") y validar dist
          command: |
            node -e "try{const p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              npm run build
            else
              echo 'No hay script "build"; se omite.'
            fi
            # Verifica que dist exista tras build (si no, no lances preview)
            if [ ! -d dist ]; then
              echo "⚠️  No existe ./dist; no se levantará vite preview."
            fi

      # ---- Levantar preview (vite) para pruebas E2E ----
      - run:
          name: Start preview server (background) y esperar disponibilidad
          command: |
            if [ -d dist ]; then
              (npm run serve:ci &> /tmp/preview.log) &
              # Espera hasta 120s a que responda
              for i in $(seq 1 120); do
                if curl -fsS "${APP_URL}" >/dev/null; then
                  echo "✅ preview listo en ${APP_URL}"
                  break
                fi
                if ! ps aux | grep -v grep | grep -q "vite preview"; then
                  echo "❌ El proceso 'vite preview' no está corriendo (falló al iniciar)."
                  echo "===== LOG preview (últimas 200 líneas) ====="
                  tail -n 200 /tmp/preview.log || true
                  exit 1
                fi
                echo "⏳ esperando preview... ($i)"
                sleep 1
              done
              # Si no respondió en el tiempo, falla con logs
              if ! curl -fsS "${APP_URL}" >/dev/null; then
                echo "❌ preview no respondió a tiempo (${APP_URL})"
                echo "===== LOG preview (últimas 200 líneas) ====="
                tail -n 200 /tmp/preview.log || true
                exit 1
              fi
              echo "===== LOG preview (primeras 80 líneas) ====="
              head -n 80 /tmp/preview.log || true
            else
              echo "⚠️  No hay ./dist, se omite preview y pruebas E2E."
            fi

      # ---- Selenium (usa tests/selenium.smoke.js) ----
      - run:
          name: Selenium smoke
          command: |
            node -e "try{const p=require('./package.json');process.exit(p.scripts && p.scripts['test:selenium']?0:1)}catch(e){process.exit(1)}"
            if [ $? -eq 0 ]; then
              if [ -d dist ]; then
                npm run test:selenium
              else
                echo "⚠️  No hay ./dist; se omite Selenium."
              fi
            else
              echo "No hay script test:selenium; se omite Selenium."
            fi

      # ---- Empaquetado y artefactos ----
      - run:
          name: Empaquetar dist.zip (si existe ./dist)
          command: |
            if [ -d dist ]; then
              zip -r dist.zip dist
            else
              echo "No existe ./dist; se omite empaquetado."
            fi
            # Evita fallo si no se creó el zip
            if [ ! -f dist.zip ]; then
              echo "No hay build; subiendo placeholder." > dist.zip
            fi

      - store_artifacts:
          path: dist.zip
          destination: dist.zip

      - store_artifacts:
          path: /tmp/preview.log
          destination: preview.log

      # --------- Telegram: éxito ---------
      - run:
          name: Notificar Telegram - SUCCESS
          when: on_success
          command: |
            if [ "<< pipeline.parameters.notify_telegram >>" = "true" ] && \
               [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
              EMOJI="✅"
              MSG="$(printf '%b' "${EMOJI} CircleCI\nEstado: SUCCESS\nRepo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nRama: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\n")"
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode=Markdown \
                   --data-urlencode text="$MSG" >/dev/null || true
            else
              echo "Telegram deshabilitado o variables no definidas."
            fi

      # --------- Telegram: fallo ---------
      - run:
          name: Notificar Telegram - FAILED
          when: on_fail
          command: |
            if [ "<< pipeline.parameters.notify_telegram >>" = "true" ] && \
               [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
              EMOJI="❌"
              MSG="$(printf '%b' "${EMOJI} CircleCI\nEstado: FAILED\nRepo: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\nRama: ${CIRCLE_BRANCH}\nBuild: ${CIRCLE_BUILD_URL}\n")"
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode=Markdown \
                   --data-urlencode text="$MSG" >/dev/null || true
            else
              echo "Telegram deshabilitado o variables no definidas."
            fi

workflows:
  build:
    jobs:
      - build_test_package

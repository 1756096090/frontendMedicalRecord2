version: 2.1

executors:
  node24:
    docker:
      - image: cimg/node:24.6

commands:
  restore_npm_cache:
    steps:
      - run:
          name: "Calcular llave del cache"
          command: |
            if [ -f package-lock.json ]; then
              echo "export NPM_LOCK_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)" >> $BASH_ENV
            else
              echo "export NPM_LOCK_HASH=no-lock" >> $BASH_ENV
            fi
            source $BASH_ENV
      - restore_cache:
          keys:
            - npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
            - npm-v1-{{ arch }}-

  save_npm_cache:
    steps:
      - save_cache:
          key: npm-v1-{{ arch }}-{{ .Environment.NPM_LOCK_HASH }}
          paths:
            - ~/.npm

jobs:
  build_and_package:
    executor: node24
    environment:
      CI: "true"
    steps:
      - checkout

      - run:
          name: Exportar REPO_NAME
          command: |
            echo "export REPO_NAME=${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" >> $BASH_ENV
            source $BASH_ENV
            echo "Repo: $REPO_NAME"
            echo "Branch: ${CIRCLE_BRANCH}"

      - restore_npm_cache

      - run:
          name: Instalar dependencias
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

      - save_npm_cache

      - run:
          name: Build (si existe script "build")
          command: |
            node -e "try{const p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)}catch(e){pro
